name: Pipeline QualitÃ© Eau - CI/CD

on:
  workflow_dispatch: {}
#   push:
#     branches:
#       - main
#       - develop
#   pull_request:
#     branches:
#       - main

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================================
  # JOB 1 : INGESTION LOCALE (GitHub Actions)
  # ============================================================
  ingestion-local:
    name: "ğŸ“¥ Ã‰tape 1 - Ingestion Locale"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ Configuration Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“š Installation des dÃ©pendances
        run: |
          echo "================================"
          echo "ğŸ“š INSTALLATION DES DÃ‰PENDANCES"
          echo "================================"
          
          python -m pip install --upgrade pip
          
          # Installation des dÃ©pendances du projet
          if [ -f requirements.txt ]; then
            echo "ğŸ“„ Installation depuis requirements.txt"
            pip install -r requirements.txt
          fi
          
          # Installation des dÃ©pendances Azure (obligatoires)
          echo "â˜ï¸  Installation des packages Azure"
          pip install azure-storage-blob azure-identity azure-core
          
          # Installation de papermill pour exÃ©cuter les notebooks
          echo "ğŸ““ Installation de papermill"
          pip install papermill nbformat nbconvert jupyter
          
          # Installation de python-dotenv si nÃ©cessaire
          pip install python-dotenv
          
          echo "âœ… Toutes les dÃ©pendances sont installÃ©es"
          
          # Afficher les packages installÃ©s
          echo ""
          echo "ğŸ“‹ Packages Azure installÃ©s :"
          pip list | grep azure

      - name: ğŸ” Configuration des variables d'environnement
        run: |
          echo "================================"
          echo "ğŸ” CONFIGURATION DES SECRETS"
          echo "================================"
          
          echo "AZURE_STORAGE_ACCOUNT_NAME=${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" >> $GITHUB_ENV
          echo "AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" >> $GITHUB_ENV
          echo "AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" >> $GITHUB_ENV
          echo "CONTAINER_RAW=${{ secrets.CONTAINER_RAW }}" >> $GITHUB_ENV
          echo "CONTAINER_BRONZE=${{ secrets.CONTAINER_BRONZE }}" >> $GITHUB_ENV
          
          echo "âœ… Variables d'environnement configurÃ©es"
          echo "ğŸ“Š Storage Account: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}"
          echo "ğŸ“Š Container Raw: ${{ secrets.CONTAINER_RAW }}"

      - name: ğŸ“ VÃ©rification du notebook
        run: |
          echo "================================"
          echo "ğŸ“ VÃ‰RIFICATION DU NOTEBOOK"
          echo "================================"
          
          if [ ! -f "00_qualite_eau_ingestion.ipynb" ]; then
            echo "âŒ Le fichier 00_qualite_eau_ingestion.ipynb n'existe pas"
            exit 1
          fi
          
          echo "âœ… Notebook trouvÃ© : 00_qualite_eau_ingestion.ipynb"
          
          # Afficher la structure du notebook
          python3 << EOF
          import json
          with open('00_qualite_eau_ingestion.ipynb', 'r', encoding='utf-8') as f:
              nb = json.load(f)
              print(f"ğŸ“Š Nombre de cellules : {len(nb['cells'])}")
              print(f"ğŸ“Š Kernel : {nb['metadata'].get('kernelspec', {}).get('name', 'N/A')}")
          EOF

      - name: ğŸš€ ExÃ©cution du notebook d'ingestion
        run: |
          echo "================================"
          echo "ğŸ“¥ Ã‰TAPE 1 : INGESTION DES DONNÃ‰ES"
          echo "================================"
          
          # Exporter les variables pour le notebook
          export AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}"
          export AZURE_STORAGE_ACCOUNT_KEY="${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}"
          export AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}"
          export CONTAINER_RAW="${{ secrets.CONTAINER_RAW }}"
          export CONTAINER_BRONZE="${{ secrets.CONTAINER_BRONZE }}"
          
          # ExÃ©cuter le notebook avec papermill (SANS paramÃ¨tres)
          papermill \
            00_qualite_eau_ingestion.ipynb \
            00_qualite_eau_ingestion_output.ipynb \
            --log-output \
            --progress-bar \
            --request-save-on-cell-execute
          
          echo ""
          echo "âœ… Ingestion terminÃ©e avec succÃ¨s"

      - name: ğŸ“Š VÃ©rification des rÃ©sultats
        if: success()
        run: |
          echo "================================"
          echo "ğŸ“Š VÃ‰RIFICATION DES RÃ‰SULTATS"
          echo "================================"
          
          echo "âœ… Notebook exÃ©cutÃ© : 00_qualite_eau_ingestion.ipynb"
          echo "ğŸ“„ Output gÃ©nÃ©rÃ© : 00_qualite_eau_ingestion_output.ipynb"
          
          # VÃ©rifier que le fichier output existe
          if [ -f "00_qualite_eau_ingestion_output.ipynb" ]; then
            echo "âœ… Fichier output crÃ©Ã© avec succÃ¨s"
            
            # Afficher un rÃ©sumÃ© du notebook exÃ©cutÃ©
            python3 << EOF
          import json
          with open('00_qualite_eau_ingestion_output.ipynb', 'r', encoding='utf-8') as f:
              nb = json.load(f)
              cells_executed = sum(1 for cell in nb['cells'] if cell.get('execution_count'))
              print(f"ğŸ“Š Cellules exÃ©cutÃ©es : {cells_executed}/{len(nb['cells'])}")
          EOF
          else
            echo "âš ï¸  Fichier output non trouvÃ©"
          fi

      - name: ğŸ’¾ Upload du notebook exÃ©cutÃ© (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: notebook-ingestion-output
          path: |
            00_qualite_eau_ingestion_output.ipynb
            *.log
          retention-days: 7

      - name: ğŸ“‹ Affichage des logs en cas d'erreur
        if: failure()
        run: |
          echo "================================"
          echo "ğŸ“‹ LOGS D'ERREUR"
          echo "================================"
          
          if [ -f "00_qualite_eau_ingestion_output.ipynb" ]; then
            echo "ğŸ“„ Extraction des erreurs du notebook..."
            
            python3 << EOF
          import json
          with open('00_qualite_eau_ingestion_output.ipynb', 'r', encoding='utf-8') as f:
              nb = json.load(f)
              for i, cell in enumerate(nb['cells'], 1):
                  if cell.get('cell_type') == 'code':
                      outputs = cell.get('outputs', [])
                      for output in outputs:
                          if output.get('output_type') == 'error':
                              print(f"\nâŒ ERREUR dans la cellule {i}:")
                              print(f"   Type: {output.get('ename', 'N/A')}")
                              print(f"   Message: {output.get('evalue', 'N/A')}")
                              traceback = output.get('traceback', [])
                              if traceback:
                                  print("   Traceback:")
                                  for line in traceback:
                                      print(f"   {line}")
          EOF
          fi

      - name: âŒ Gestion des erreurs
        if: failure()
        run: |
          echo ""
          echo "================================"
          echo "âŒ ERREUR LORS DE L'INGESTION"
          echo "================================"
          echo ""
          echo "ğŸ“„ Consultez les logs ci-dessus pour plus de dÃ©tails"
          echo "ğŸ’¡ VÃ©rifiez :"
          echo "   - Les credentials Azure sont corrects"
          echo "   - Le container existe"
          echo "   - Les permissions sont configurÃ©es"
          echo ""
          exit 1

      - name: âœ… RÃ©sumÃ© de l'exÃ©cution
        if: success()
        run: |
          echo ""
          echo "================================"
          echo "âœ… INGESTION TERMINÃ‰E AVEC SUCCÃˆS"
          echo "================================"
          echo ""
          echo "ğŸ“Š RÃ©sumÃ© :"
          echo "   âœ… Notebook exÃ©cutÃ© : 00_qualite_eau_ingestion.ipynb"
          echo "   âœ… Output disponible : 00_qualite_eau_ingestion_output.ipynb"
          echo "   âœ… Artifacts uploadÃ©s : notebook-ingestion-output"
          echo ""
          echo "ğŸ‰ Ã‰tape 1 du pipeline complÃ©tÃ©e !"
          echo "================================"